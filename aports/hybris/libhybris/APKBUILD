pkgname=libhybris
pkgver=1263.013cf7e
pkgrel=1
arch="all"
url="https://github.com/libhybris/libhybris"
license="Apache"
makedepends="autoconf automake libtool wayland-dev linux-headers bsd-compat-headers
             libx11-dev libxcb-dev libxext-dev
             android-headers-7.1 android-headers-7.1-caf android-headers-4.4"
depends_dev="bsd-compat-headers android-headers-7.1"
_rev=54dd4749706334882f9c404fca01a19f01325d07
source="$pkgname-$_rev.tar.gz::https://github.com/libhybris/libhybris/archive/$_rev.tar.gz
	0001-Make-libhybris-compile-with-musl.patch
	0002-tests-Regression-test-for-EGL-glibc-TLS-conflict.patch
	0003-Implement-X11-EGL-platform-based-on-wayland-code.patch
	0004-mtk-test_hwcomposer-fix.patch
	0005-dont-hardcode-libhardware-path.patch"

pkgdesc="libhybris allows to use bionic-based HW adaptations"
subpackages="$pkgname-dev $pkgname-egl $pkgname-gles $pkgname-libwayland-egl:_wayland
	$pkgname-7.1:_specific $pkgname-7.1-caf:_specific $pkgname-4.4:_specific"

if [ "$CARCH" == "aarch64" ]; then
subpackages="$pkgname-dev $pkgname-egl $pkgname-gles $pkgname-libwayland-egl:_wayland
	$pkgname-7.1:_specific $pkgname-7.1-caf:_specific"
fi

options="!check !strip"

builddir="$srcdir/$pkgname-$_rev"
_tmppkgdir="$srcdir/tmpinstall"
_main_headers_ver=7.1

_bins_specific="test_audio test_camera test_egl_configs	test_gps
	test_hwcomposer	test_input test_lights test_media test_nfc
	test_recorder test_sensors test_sf test_vibrator test_wifi"

_libs_specific="libcamera.so.1.0.0 libhardware.so.2.0.0
	libhybris-common.so.1.0.0 libhybris-eglplatformcommon.so.1.0.0
	libhybris-hwcomposerwindow.so.1.0.0 libis.so.1.0.0 libmedia.so.1
	libmedia.so.1.0.0 libnfc_ndef_nxp.so.1.0.0 libnfc_nxp.so.1.0.0
	libsf.so.1.0.0 libsync.so.2.0.0 libui.so.1.0.0 libvibrator.so.1.0.0
	libwifi.so.1.0.0
	libhybris/eglplatform_fbdev.so libhybris/eglplatform_hwcomposer.so
	libhybris/eglplatform_null.so libhybris/eglplatform_wayland.so
	libhybris/eglplatform_x11.so"

build() {
	cd "$builddir/hybris"

	NOCONFIGURE=1 ./autogen.sh

	if [ "$CARCH" == "armhf" ]; then
        _vers="7.1 7.1-caf 4.4"
        _ldpath="/usr/libexec/droid-hybris/system/lib:/vendor/lib:/system/lib"
        _arch="arm"
	elif [ "$CARCH" == "aarch64" ]; then
        _vers="7.1 7.1-caf"
        _ldpath="/usr/libexec/droid-hybris/system/lib64:/vendor/lib64:/system/lib64"
        _arch="arm64"
    fi

	for _headers_ver in $_vers; do
		msg "building $pkgname-$_headers_ver"
		./configure \
			--prefix=/usr \
			--enable-wayland \
			--enable-trace \
			--enable-debug \
			--enable-experimental \
			--with-android-headers=/usr/include/android-$_headers_ver \
			--with-default-hybris-ld-library-path=$_ldpath \
			--enable-arch=$_arch \
			--enable-property-cache
		make DESTDIR="${_tmppkgdir}/$pkgname-$_headers_ver" install
	done
}

package() {
	cd "$builddir/hybris"

	# make DESTDIR="${pkgdir}" install
	mkdir -p "${pkgdir}"
	cp -a ${_tmppkgdir}/$pkgname-$_main_headers_ver/* "${pkgdir}"

	for _bin in ${_bins_specific}; do
		rm "${pkgdir}/usr/bin/${_bin}"
	done

	for _lib in ${_libs_specific}; do
		rm "${pkgdir}/usr/lib/${_lib}"
	done
}

_specific() {
	for _bin in ${_bins_specific}; do
		install -Dm755 "${_tmppkgdir}/${subpkgname}/usr/bin/${_bin}" \
			"${subpkgdir}/usr/bin/${_bin}"
	done

	for _lib in ${_libs_specific}; do
		install -Dm755 "${_tmppkgdir}/${subpkgname}/usr/lib/${_lib}" \
			"${subpkgdir}/usr/lib/${_lib}"
	done
}

egl() {
	options="!tracedeps"
	pkgdesc="libhybris libEGL runtime libraries"
	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libEGL.so.* \
		"$subpkgdir"/usr/lib/
}

gles() {
	options="!tracedeps"
	pkgdesc="libhybris libGLESv2 runtime libraries"
	install -d "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libGLES*.so.* \
		"$subpkgdir"/usr/lib/
}

_wayland() {
	pkgdesc="libhybris libwayland-egl library"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libwayland-egl.so.* "$subpkgdir"/usr/lib/ \
		|| return 1
}

dev() {
	default_dev

	# Avoid conflicts with mesa-dev
	rm -f "$subpkgdir"/usr/lib/lib*GL*.so
	rm -f "$subpkgdir"/usr/lib/libwayland-egl.so

	cd "$subpkgdir"/usr/lib/pkgconfig
	rm -f egl.pc glesv*.pc wayland-egl.pc

	cd "$subpkgdir"/usr/include
	# Move libhybris-provided headers into hybris dir
	mv CL EGL GLES GLES2 KHR VG hybris

	# Symlink eglhybris.h
	mkdir -p EGL
	cd EGL
	ln -s ../hybris/EGL/eglhybris.h .
}

sha512sums="798360130e540d9dd29ec937b3d01a1b146881c45ec6a2dd1a599a0164d46886b58927d38575993b525a06e99fcc2dd46f020e70f7e5c7cc43258b840ae183f8  libhybris-54dd4749706334882f9c404fca01a19f01325d07.tar.gz
065d0f4f5db08b0aa240672fed5a498c2fa05677c0c3c3929edb27ca6d2077ddb310f9a1d1dd3167c72edc4540c6cd6a6ee0aef36334fa78b132f3e19cd5a198  0001-Make-libhybris-compile-with-musl.patch
c9a14fa22b2799cc2f8c4ac7103e6c5484a2d91e7a92c5361e7e6c8b372f378ccd39913e941796c4edabfa70dc2518141e48da8b61dd5c570679d182fc6c6ea0  0002-tests-Regression-test-for-EGL-glibc-TLS-conflict.patch
6c5aca2213a5ef29973d717d3bb25b4c9c845c6614769e805cd3bdd4282f418a7dda17ad3382e09b45e83826b320339a520904a998a62797f32782b0a049fda6  0003-Implement-X11-EGL-platform-based-on-wayland-code.patch
30a5fbee8bc6c6b5590cb0e8adbbced2fbea80d8ce094c2cf79a776deb3ba012489fc779d51157bb56e08daaacab68bb4333223dea791d72d583f79813bcd7a8  0004-mtk-test_hwcomposer-fix.patch
88a26d6c56c2b3871fa2b6c724180846d03482b0a25e7fec45c69f48ed530b7c8a253987e6ece95cdebbad79fd981e8ed4c69f796e2130b91c09fd04bfc3513e  0005-dont-hardcode-libhardware-path.patch"
